---
/**
 * OptimizedImage - Uses Astro's built-in Image component for optimization
 * 
 * Supports three image source types:
 * 1. Remote URLs (http/https) - Optimized via configured domains in astro.config.mjs
 * 2. Imported images (ImageMetadata) - Full build-time optimization with srcset
 * 3. Local paths (/images/...) - Served as-is from public folder (fallback)
 */
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  src: string | ImageMetadata;
  alt: string;
  width?: number;
  height?: number;
  aspectRatio?: number; // width / height
  sizes?: string; // e.g., "(max-width: 768px) 100vw, 50vw"
  loading?: 'lazy' | 'eager';
  className?: string;
  fallbackSrc?: string;
  quality?: number; // 1-100, default 80
}

const {
  src: rawSrc,
  alt,
  width,
  height,
  aspectRatio,
  sizes,
  loading = 'lazy',
  className = '',
  fallbackSrc,
  quality = 80,
} = Astro.props;

// Determine the type of image source
const isImageMetadata = typeof rawSrc === 'object' && rawSrc !== null && 'src' in rawSrc;
const isRemoteUrl = typeof rawSrc === 'string' && (rawSrc.startsWith('http://') || rawSrc.startsWith('https://'));
const isLocalPath = typeof rawSrc === 'string' && rawSrc.startsWith('/');
const hasSrc = rawSrc && (isImageMetadata || (typeof rawSrc === 'string' && rawSrc.length > 0));

// Calculate dimensions if aspectRatio is provided
let finalWidth = width;
let finalHeight = height;

if (aspectRatio && finalWidth && !finalHeight) {
  finalHeight = Math.round(finalWidth / aspectRatio);
} else if (aspectRatio && finalHeight && !finalWidth) {
  finalWidth = Math.round(finalHeight * aspectRatio);
}

// For remote images, we need BOTH dimensions for Astro's Image component
// If we have aspectRatio, we can calculate the missing dimension
if (aspectRatio) {
  if (finalWidth && !finalHeight) {
    finalHeight = Math.round(finalWidth / aspectRatio);
  } else if (finalHeight && !finalWidth) {
    finalWidth = Math.round(finalHeight * aspectRatio);
  } else if (!finalWidth && !finalHeight) {
    // Default dimensions when neither is provided
    finalWidth = 800;
    finalHeight = Math.round(finalWidth / aspectRatio);
  }
}

// For remote images without dimensions, use sensible defaults instead of inferSize
// inferSize can cause issues with very large images and is slower
if (isRemoteUrl && (!finalWidth || !finalHeight)) {
  // Default to a reasonable size for remote images
  if (!finalWidth) finalWidth = 800;
  if (!finalHeight) finalHeight = 800; // Square as fallback
}

// For imported images, get dimensions from metadata if not specified
if (isImageMetadata && !finalWidth && !finalHeight) {
  const metadata = rawSrc as ImageMetadata;
  finalWidth = metadata.width;
  finalHeight = metadata.height;
}
---

{!hasSrc ? (
  /* No valid src - render fallback or nothing */
  fallbackSrc ? (
    <img
      src={fallbackSrc}
      alt={alt}
      width={finalWidth}
      height={finalHeight}
      loading={loading}
      class={className}
    />
  ) : null
) : isImageMetadata ? (
  /* Imported image - full Astro optimization with WebP/AVIF and srcset */
  <Image
    src={rawSrc as ImageMetadata}
    alt={alt}
    width={finalWidth}
    height={finalHeight}
    quality={quality}
    loading={loading}
    class={className}
    format="webp"
    style="width: 100%; height: 100%; object-fit: cover; object-position: center;"
  />
) : isRemoteUrl ? (
  /* Remote URL with dimensions - Astro optimization via configured domains */
  <Image
    src={rawSrc as string}
    alt={alt}
    width={finalWidth!}
    height={finalHeight!}
    quality={quality}
    loading={loading}
    class={className}
    format="webp"
    style="width: 100%; height: 100%; object-fit: cover; object-position: center;"
  />
) : isLocalPath ? (
  /* Local path from public/ - serve as-is (can't optimize without import) */
  <img
    src={rawSrc as string}
    alt={alt}
    width={finalWidth}
    height={finalHeight}
    loading={loading}
    class={className}
    onerror={fallbackSrc ? `this.src='${fallbackSrc}'; this.onerror=null;` : undefined}
  />
) : (
  /* Fallback for any other string src */
  <img
    src={rawSrc as string}
    alt={alt}
    width={finalWidth}
    height={finalHeight}
    loading={loading}
    class={className}
    onerror={fallbackSrc ? `this.src='${fallbackSrc}'; this.onerror=null;` : undefined}
  />
)}

<style>
  :global(.optimized-image) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
  }
</style>
