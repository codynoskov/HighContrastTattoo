---
import Tag from "./Tag.astro";
import ArtistImage from "./ArtistImage.astro";
import Button from "./Button.astro";
import { getImage } from "astro:assets";
import imagePlaceholder from "../assets/images/image-placeholder.png";
import type { ImageMetadata } from "astro";

interface TagWithLink {
  text: string;
  href?: string;
}

interface Props {
  type?: "Style" | "Artist";
  fillHeight?: boolean;
  title?: string;
  description?: string;
  descriptionSize?: "sm" | "md" | "lg";
  image?: string | ImageMetadata;
  imageAlt?: string;
  tags?: string[] | TagWithLink[];
  artistTags?: string[] | TagWithLink[];
  artistLinks?: Array<{ name: string; href: string }>;
  instagram?: string;
  href?: string;
  className?: string;
}

const { 
  type = "Style",
  fillHeight = true,
  title = "Style name",
  description = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque aliquam massa nec dui pharetra, non commodo quam maximus. Maecenas sapien sem, scelerisque quis varius at, ultrices vitae tortor. Vivamus cursus arcu mauris, eget blandit urna mollis a. Etiam eu consequat velit, tincidunt placerat augue.",
  descriptionSize = "md",
  image,
  imageAlt = "",
  tags = [],
  artistTags = [],
  artistLinks = [],
  instagram,
  href,
  className = ""
} = Astro.props;

const isArtist = type === "Artist";
const rawDisplayTags = isArtist ? artistTags : tags;
// Normalize tags to TagWithLink format
const displayTags: TagWithLink[] = rawDisplayTags.map((tag) => 
  typeof tag === 'string' ? { text: tag } : tag
);
const buttonText = isArtist ? "Meet the artist" : "Explore style";
const descriptionSizeClass = `card-description-${descriptionSize}`;

// Get optimized image URL for background-image
let backgroundImageUrl = '';
if (!isArtist) {
  // Always pre-optimize the placeholder so we have a guaranteed fallback
  const optimizedPlaceholder = await getImage({
    src: imagePlaceholder,
    width: 364,
    height: 273,
    quality: 85,
    format: 'webp'
  });
  const placeholderUrl = optimizedPlaceholder.src.toString();
  
  const imageSrc = image || imagePlaceholder;
  const isRemoteUrl = typeof imageSrc === 'string' && (imageSrc.startsWith('http://') || imageSrc.startsWith('https://'));
  const isImageMetadata = typeof imageSrc === 'object' && imageSrc !== null && 'src' in imageSrc;
  
  try {
    if (isImageMetadata) {
      // For imported images (ImageMetadata) - full Astro optimization
      const optimized = await getImage({
        src: imageSrc as ImageMetadata,
        width: 364,
        height: 273,
        quality: 85,
        format: 'webp'
      });
      backgroundImageUrl = optimized.src.toString();
    } else if (isRemoteUrl) {
      // For remote URLs (R2 images) - serve directly from CDN without build-time processing
      backgroundImageUrl = imageSrc as string;
    } else {
      // For local path strings or any other case, use the pre-optimized placeholder
      backgroundImageUrl = placeholderUrl;
    }
  } catch (error) {
    // Fallback to the pre-optimized placeholder if anything fails
    backgroundImageUrl = placeholderUrl;
  }
  
  // Final safety check - if backgroundImageUrl is still empty, use placeholder
  if (!backgroundImageUrl) {
    backgroundImageUrl = placeholderUrl;
  }
}
---

<article class={`card card-${type} ${fillHeight ? 'card-fill' : 'card-hug'} ${className}`}>
  <div class="card-group">
    {!isArtist && (
      <div 
        class="card-header-image"
        style={`background-image: url(${backgroundImageUrl});`}
        role="img"
        aria-label={imageAlt || "Card image"}
      ></div>
    )}
    {isArtist && (
      <div class="card-header-artist">
        <ArtistImage image={image} imageAlt={imageAlt || "Artist image"} />
      </div>
    )}
    <div class="card-body">
      <div class="card-content">
        <h3 class="card-title">{title}</h3>
        <p class={`card-description ${descriptionSizeClass}`}>{description}</p>
        {!isArtist && artistLinks.length > 0 && (
          <p class="card-artists">
            <strong>Artists working in this style:</strong>{" "}
            <span set:html={artistLinks.map((artist, index) => 
              `<a href="${artist.href}" class="card-artist-link">${artist.name}</a>${index < artistLinks.length - 1 ? ', ' : ''}`
            ).join('')} />
          </p>
        )}
        {isArtist && instagram && (
          <p class="card-instagram">
            <strong>Instagram:</strong> <a href={`https://instagram.com/${instagram.replace('@', '')}`} target="_blank" rel="noopener noreferrer" class="card-instagram-link">@{instagram.replace('@', '')}</a>
          </p>
        )}
        {isArtist && displayTags.length > 0 && (
          <p class="card-styles">
            <strong>Styles the artist works in:</strong>{" "}
            <span set:html={displayTags.map((tag, index) => 
              `<a href="${tag.href || '#'}" class="card-style-link">${tag.text}</a>${index < displayTags.length - 1 ? ', ' : ''}`
            ).join('')} />
          </p>
        )}
      </div>
    </div>
    <div class="card-footer">
      <div class="card-footer-content">
        <Button 
          type="Primary" 
          color="Primary"
          leadingIcon={false}
          trailingIcon={true}
          href={href}
          className="card-button"
        >
          {buttonText}
        </Button>
      </div>
    </div>
  </div>
</article>

<style>
  .card {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    background-color: var(--color-neutral-50);
    border: var(--border-width-default) solid var(--color-neutral-200);
    width: 100%;
    max-width: 364px;
    min-height: 0;
  }

  .card-fill {
    /* Cards will stretch via align-items: stretch on parent */
  }

  .card-hug {
    /* Cards will stretch via align-items: stretch on parent */
  }

  .card-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
    height: 100%;
    flex: 1;
    min-height: 0;
  }

  /* Style Card - Header Image */
  .card-Style .card-header-image {
    position: relative;
    width: 100%;
    padding-bottom: 75%; /* 4:3 aspect ratio (3/4 = 0.75 = 75%) */
    flex-shrink: 0;
    overflow: hidden;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-color: var(--color-neutral-200); /* Fallback color if image fails to load */
  }


  /* Artist Card - Header */
  .card-Artist .card-header-artist {
    padding: var(--spacing-core-800-md);
    padding-bottom: 0;
    padding-top: var(--spacing-core-800-md);
  }

  .card-body {
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
    width: 100%;
    flex: 1;
    min-height: 0;
  }

  .card-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-core-800-md);
    align-items: flex-start;
    padding: var(--spacing-core-800-md);
    width: 100%;
    flex: 1;
    min-height: 0;
    justify-content: flex-start;
  }

  .card-title {
    font: var(--typography-h3);
    color: var(--color-text);
    margin: 0;
    width: 100%;
  }

  .card-description {
    font: var(--typography-body-md);
    color: var(--color-primary-900);
    margin: 0;
    width: 100%;
  }

  .card-description-sm {
    font: var(--typography-body-sm);
  }

  .card-description-md {
    font: var(--typography-body-md);
  }

  .card-description-lg {
    font: var(--typography-body-lg);
  }

  .card-artists,
  .card-instagram,
  .card-styles {
    font: var(--typography-body-md);
    color: var(--color-primary-900);
    margin: 0;
    width: 100%;
    font-size: var(--font-size-core-700-md);
    line-height: var(--line-height-core-800-md);
  }

  .card-artists strong,
  .card-instagram strong,
  .card-styles strong {
    font-weight: var(--font-weight-bold);
    font-family: var(--font-stack-sans);
    line-height: var(--line-height-core-800-md);
  }

  .card-artist-link,
  .card-instagram-link,
  .card-style-link {
    color: var(--color-primary-900);
    text-decoration: underline;
    text-underline-position: from-font;
    font-weight: var(--font-weight-light);
  }

  .card-artist-link:hover,
  .card-instagram-link:hover,
  .card-style-link:hover {
    color: var(--color-primary-700);
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-core-500-md);
    align-items: flex-start;
    width: 100%;
  }

  .card-footer {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    flex-shrink: 0;
    margin-top: auto;
  }

  .card-footer-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    flex: 1;
    padding: var(--spacing-core-800-md);
  }

  .card-button {
    width: 100%;
  }

</style>
