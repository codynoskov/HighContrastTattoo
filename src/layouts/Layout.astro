---
import '../styles/tokens.css';
import '../styles/fonts.css';
import '../styles/typography.css';
import SEO from '../components/SEO.astro';
import LocalBusinessSchema from '../components/LocalBusinessSchema.astro';
import ServiceSchema from '../components/ServiceSchema.astro';
import PersonSchema from '../components/PersonSchema.astro';
import BreadcrumbListSchema from '../components/BreadcrumbListSchema.astro';
import WebPageSchema from '../components/WebPageSchema.astro';
import PostHog from '../components/posthog.astro';
import { getCollection } from 'astro:content';
import { getFaviconUrl } from '../utils/contentHelpers';

interface BreadcrumbItem {
  name: string;
  url: string;
}

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  ogType?: 'website' | 'article' | 'profile';
  canonicalUrl?: string;
  noIndex?: boolean;
  includeLocalBusiness?: boolean;
  includeServiceSchema?: boolean;
  includePersonSchema?: boolean;
  personName?: string;
  personImage?: string;
  personUrl?: string;
  personSameAs?: string;
  breadcrumbItems?: BreadcrumbItem[];
  /** Optional dates for WebPage schema (freshness signals) */
  datePublished?: string | Date;
  dateModified?: string | Date;
}

const {
  title,
  description,
  ogImage,
  ogType = 'website',
  canonicalUrl,
  noIndex = false,
  includeLocalBusiness = false,
  includeServiceSchema = false,
  includePersonSchema = false,
  personName,
  personImage,
  personUrl,
  personSameAs,
  breadcrumbItems,
  datePublished,
  dateModified,
} = Astro.props;

// Get global settings for SEO defaults
const settingsEntries = await getCollection('settings');
const settings = settingsEntries[0]?.data || {};

// Compute aggregate rating from reviews when showing LocalBusiness (e.g. homepage)
let aggregateRating: { ratingValue: number; reviewCount: number; bestRating: number; worstRating: number } | undefined;
if (includeLocalBusiness) {
  const reviewsEntries = await getCollection('reviews');
  if (reviewsEntries.length > 0) {
    const sum = reviewsEntries.reduce((acc, r) => acc + (r.data.rating ?? 5), 0);
    aggregateRating = {
      ratingValue: Math.round((sum / reviewsEntries.length) * 10) / 10,
      reviewCount: reviewsEntries.length,
      bestRating: 5,
      worstRating: 1,
    };
  }
}

// SEO defaults from settings
const siteName = settings.seoSiteName || settings.studioName || 'High Contrast Tattoo';
const siteUrl = settings.seoSiteUrl || '';
const defaultDescription = settings.seoDefaultDescription || '';
const defaultOgImage = settings.seoDefaultOgImage || '/images/og-hct.png';

// Staging noindex: when SITE contains pages.dev, force noindex on all pages
const isStaging = (import.meta.env.SITE || siteUrl || '').includes('pages.dev');
const effectiveNoIndex = isStaging || noIndex;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<!-- Preload critical fonts to reduce FOUT (flash of unstyled text) -->
		<link rel="preload" href="/fonts/stack-sans-text-300.woff2" as="font" type="font/woff2" crossorigin />
		<link rel="preload" href="/fonts/stack-sans-text-400.woff2" as="font" type="font/woff2" crossorigin />
		<link rel="preload" href="/fonts/stack-sans-notch-300.woff2" as="font" type="font/woff2" crossorigin />
		<link rel="preload" href="/fonts/stack-sans-notch-400.woff2" as="font" type="font/woff2" crossorigin />
		<!-- Preconnect to R2 for faster image/video loading -->
		<link rel="preconnect" href="https://pub-5fa780a0c82a42df836a1dd9282c562b.r2.dev" crossorigin />
		<link rel="icon" type="image/x-icon" href={getFaviconUrl('favicon.ico')} />
		<link rel="icon" type="image/png" sizes="16x16" href={getFaviconUrl('favicon-16x16.png')} />
		<link rel="icon" type="image/png" sizes="32x32" href={getFaviconUrl('favicon-32x32.png')} />
		<link rel="apple-touch-icon" sizes="180x180" href={getFaviconUrl('apple-touch-icon.png')} />
		<link rel="manifest" href="/site.webmanifest" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- PostHog Analytics -->
		<PostHog />
		
		<!-- SEO Meta Tags -->
		<SEO
			title={title}
			description={description}
			ogImage={ogImage}
			ogType={ogType}
			canonicalUrl={canonicalUrl}
			noIndex={effectiveNoIndex}
			siteName={siteName}
			siteUrl={siteUrl}
			defaultDescription={defaultDescription}
			defaultOgImage={defaultOgImage}
		/>

		<!-- Local Business Structured Data (homepage only) -->
		{includeLocalBusiness && (
			<LocalBusinessSchema
				name={settings.studioName || 'High Contrast Tattoo'}
				address={settings.footerAddress || ''}
				phone={settings.footerPhone || ''}
				email={settings.footerEmail || ''}
				siteUrl={siteUrl}
				googleMapsUrl={settings.seoGoogleMapsUrl}
				instagramUrl={settings.seoInstagramUrl}
				ogImage={defaultOgImage}
				aggregateRating={aggregateRating}
			/>
		)}

		<!-- Service Structured Data (homepage only) -->
		{includeServiceSchema && (
			<ServiceSchema
				name="Custom Tattoo Appointment"
				description="Book a custom tattoo consultation and session at High Contrast Tattoo Berlin. Discuss your idea, placement, and style with our experienced artists. Neo-traditional, blackwork, floral, fineline and more."
				providerName={settings.studioName || 'High Contrast Tattoo'}
				siteUrl={siteUrl}
			/>
		)}

		<!-- Person Structured Data (artist pages only) -->
		{includePersonSchema && personName && personImage && personUrl && (
			<PersonSchema
				name={personName}
				image={personImage}
				url={personUrl}
				sameAs={personSameAs}
			/>
		)}

		<!-- BreadcrumbList Structured Data -->
		{breadcrumbItems && breadcrumbItems.length > 0 && (
			<BreadcrumbListSchema items={breadcrumbItems} />
		)}

		<!-- WebPage with dateModified/datePublished (freshness signals) -->
		{canonicalUrl && (dateModified || datePublished) && (
			<WebPageSchema
				url={canonicalUrl}
				datePublished={datePublished}
				dateModified={dateModified}
			/>
		)}
		
		<!-- Fonts are loaded locally for GDPR compliance - no external requests -->
	</head>
	<body>
		<slot />
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
		font: var(--typography-body-md);
		color: var(--color-text);
		background-color: var(--color-background);
	}
</style>
