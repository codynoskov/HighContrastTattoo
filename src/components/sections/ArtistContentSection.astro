---
import Gallery from '../Gallery.astro';
import Button from '../Button.astro';

interface GalleryImage {
  src: string;
  alt?: string;
  tags?: Array<{
    text: string;
    color?: "Primary" | "Accent" | "Neutral";
  }>;
}

interface Props {
  galleryImages?: GalleryImage[];
  details?: string;
  showBackLink?: boolean;
  className?: string;
}

const {
  galleryImages = [],
  details,
  showBackLink = true,
  className = ""
} = Astro.props;

// Single continuous gallery - all images shown

// Render markdown to HTML - handles H2 headings and paragraphs
function renderMarkdown(markdown: string | undefined): string {
  if (!markdown) return '';
  
  // Split by double newlines to get paragraphs
  const paragraphs = markdown
    .split(/\n\n+/)
    .map(p => p.trim())
    .filter(p => p.length > 0);
  
  return paragraphs.map(para => {
    let html = para;
    
    // H2 Headers (must be at start of line, ##)
    if (/^##\s/.test(html)) {
      html = html.replace(/^##\s(.+)$/gm, '<h2>$1</h2>');
      // Process any bold text within headers
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      return html;
    }
    
    // Regular paragraph - process inline markdown
    // Bold
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    // Italic
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    // Links
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
    // Line breaks within paragraph
    html = html.replace(/\n/g, '<br>');
    
    return `<p>${html}</p>`;
  }).join('');
}

const detailsHtml = renderMarkdown(details);
---

<section class={`artist-content-section ${className}`}>
  <div class="container">
    <!-- Gallery (all images, starting with 3, continuing from 4th) -->
    {galleryImages.length > 0 && (
      <div class="gallery-wrapper">
        <Gallery images={galleryImages} maxVisible={galleryImages.length} />
      </div>
    )}

    <!-- Details Content -->
    {details && (
      <div class="details-content" set:html={detailsHtml} />
    )}

    <!-- Back Link -->
    {showBackLink && (
      <div class="back-link-wrapper">
        <Button
          type="Secondary"
          color="Primary"
          href="/artists"
          leadingIcon={true}
          leadingIconName="chevron-left"
          trailingIcon={false}
        >
          Explore all artists
        </Button>
      </div>
    )}
  </div>
</section>

<style>
  .artist-content-section {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: transparent;
    padding: var(--spacing-core-1100-md) 0;
    /* Overlap with hero section by -144px */
    margin-top: calc(-1 * var(--spacing-core-1300-lg));
    position: relative;
    z-index: 1;
  }

  .artist-content-section :global(.container) {
    gap: var(--spacing-core-1100-md);
  }

  /* Gallery */
  .gallery-wrapper {
    width: 100%;
  }

  /* Details Content */
  .details-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-core-900-md);
    width: 100%;
    max-width: 640px;
  }

  .details-content :global(p) {
    font: var(--typography-body-md);
    color: var(--color-primary-900);
    margin: 0 0 var(--spacing-core-700-md) 0;
    font-weight: var(--font-weight-light);
    line-height: var(--line-height-core-800-md);
  }

  .details-content :global(p:last-child) {
    margin-bottom: 0;
  }

  .details-content :global(h2) {
    font: var(--typography-h2);
    color: var(--color-primary-900);
    margin: 0 0 var(--spacing-core-700-md) 0;
  }

  .details-content :global(strong) {
    font-weight: var(--font-weight-bold);
  }

  .details-content :global(em) {
    font-style: italic;
  }

  .details-content :global(a) {
    color: var(--color-primary-900);
    text-decoration: underline;
    text-underline-position: from-font;
  }

  .details-content :global(a:hover) {
    color: var(--color-primary-700);
  }


  /* Back Link */
  .back-link-wrapper {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
    padding-top: var(--spacing-core-700-md);
  }

  /* Override the chevron-left icon rotation in the secondary button */
  .back-link-wrapper :global(.icon-leading .icon svg) {
    transform: rotate(-90deg) scaleY(-1);
  }

  /* Mobile Layout */
  @media (max-width: 767px) {
    .artist-content-section {
      padding: var(--spacing-core-900-md) 0;
    }

    .artist-content-section :global(.container) {
      gap: var(--spacing-core-900-md);
    }

    .details-content {
      gap: var(--spacing-core-700-md);
    }

    .back-link-wrapper {
      padding-top: var(--spacing-core-500-md);
    }
  }
</style>
