---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Divider from '../components/Divider.astro';
import ArtistsHeroSection from '../components/sections/ArtistsHeroSection.astro';
import InputField from '../components/InputField.astro';
import Checkbox from '../components/Checkbox.astro';
import Button from '../components/Button.astro';
import { getCollection } from 'astro:content';
import { resolveImage } from '../utils/contentHelpers';

// Get settings content
const settingsEntries = await getCollection('settings');
const settings = settingsEntries[0]?.data || {};
const footerMapImage = settings.footerMapImage ? resolveImage(settings.footerMapImage) : undefined;

const styleEntries = await getCollection('styles');
// Sort styles by order if defined, otherwise alphabetically
const sortedStyles = [...styleEntries].sort((a, b) => {
  // If both have order, sort by order
  if (a.data.order !== undefined && b.data.order !== undefined) {
    return a.data.order - b.data.order;
  }
  
  // If only one has order, it comes first
  if (a.data.order !== undefined) return -1;
  if (b.data.order !== undefined) return 1;
  
  // If neither has order, sort alphabetically by name
  return a.data.name.localeCompare(b.data.name);
});
const styles = sortedStyles.map(entry => ({
  ...entry.data,
  slug: entry.slug
}));

const artistEntries = await getCollection('artists');
// Sort artists by order if defined, otherwise alphabetically
const sortedArtists = [...artistEntries].sort((a, b) => {
  // If both have order, sort by order
  if (a.data.order !== undefined && b.data.order !== undefined) {
    return a.data.order - b.data.order;
  }
  
  // If only one has order, it comes first
  if (a.data.order !== undefined) return -1;
  if (b.data.order !== undefined) return 1;
  
  // If neither has order, sort alphabetically by name
  return a.data.name.localeCompare(b.data.name);
});
const artists = sortedArtists.map(entry => ({
  ...entry.data,
  slug: entry.slug
}));

// SEO - Booking page
const siteUrl = settings.seoSiteUrl || 'https://highcontrasttattoo.com';
const seoTitle = `Book an Appointment | ${settings.seoSiteName || 'High Contrast Tattoo'}`;
const seoDescription = 'Book a tattoo appointment at High Contrast Tattoo Berlin. Discuss your idea, placement, and details with our experienced artists.';
---

<Layout
  title={seoTitle}
  description={seoDescription}
  canonicalUrl={`${siteUrl}/book`}
  breadcrumbItems={[
    { name: 'Home', url: siteUrl + '/' },
    { name: 'Book', url: siteUrl + '/book' },
  ]}
>
  <Header 
    studioName={settings.studioName}
    buttonBookSession={settings.buttonBookSession}
  />
  <main>
    <ArtistsHeroSection 
      title="Book an appointment"
      description="Book an appointment to discuss your idea, placement, and details, and secure your session."
    />

    <Divider />

    <!-- Form Section -->
    <section class="form-section">
      <div class="form-container">
        <form class="booking-form" id="booking-form">
          <div class="form-grid">
            <!-- Row 1: Name & Email -->
            <div class="form-field">
              <InputField
                type="Field"
                label="Name"
                name="name"
                id="name"
                mandatoryField={true}
                optionalHint={false}
              />
            </div>
            <div class="form-field">
              <InputField
                type="Field"
                label="Email"
                name="email"
                id="email"
                mandatoryField={true}
                optionalHint={false}
              />
            </div>

            <!-- Row 2: City & Phone -->
            <div class="form-field">
              <InputField
                type="Field"
                label="City (optional)"
                name="city"
                id="city"
                mandatoryField={false}
                optionalHint={false}
              />
            </div>
            <div class="form-field">
              <InputField
                type="Field"
                label="Phone number (optional)"
                name="phone"
                id="phone"
                mandatoryField={false}
                optionalHint={false}
              />
            </div>

            <!-- Row 3: Style & Preferred Artist -->
            <div class="form-field">
              <InputField
                type="Dropdown"
                label="Style"
                name="style"
                id="style"
                placeholder="Choose a style"
                mandatoryField={true}
                optionalHint={true}
              >
                {styles.map((style) => (
                  <option value={style.slug}>{style.name}</option>
                ))}
              </InputField>
            </div>
            <div class="form-field">
              <InputField
                type="Dropdown"
                label="Preferred artist (optional)"
                name="artist"
                id="artist"
                placeholder="Choose an artist"
                mandatoryField={false}
                optionalHint={true}
              >
                {artists.map((artist) => (
                  <option value={artist.name}>{artist.name}</option>
                ))}
              </InputField>
            </div>

            <!-- Row 4: Body Placement & Size -->
            <div class="form-field">
              <InputField
                type="Field"
                label="Body placement"
                name="placement"
                id="placement"
                placeholder="Example: forearm, upper arm, shoulder, ribs, thigh, etc."
                mandatoryField={true}
                optionalHint={true}
              />
            </div>
            <div class="form-field">
              <InputField
                type="Field"
                label="Approx. size (cm)"
                name="size"
                id="size"
                mandatoryField={true}
                optionalHint={false}
              />
            </div>

            <!-- Row 5: Tattoo Description (full width) -->
            <div class="form-field form-field-full">
              <InputField
                type="Area"
                label="Tattoo description"
                name="description"
                id="description"
                placeholder="Describe your tattoo idea, style preferences, or any details you'd like us to know"
                mandatoryField={false}
                optionalHint={true}
              />
            </div>

            <!-- Row 6: Age Confirmation Checkbox (full width) -->
            <div class="form-field form-field-full">
              <div class="checkbox-group">
                <Checkbox state="Empty" name="age-confirmation" />
                <div class="checkbox-label-group">
                  <span class="mandatory-indicator">*</span>
                  <span class="checkbox-label">I am at least 18 years old</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="form-actions">
            <Button
              type="Primary"
              color="Accent"
              leadingIcon={false}
              trailingIcon={true}
              trailingIconName="check"
              buttonType="submit"
            >
              Book Session now
            </Button>
          </div>
        </form>
      </div>
    </section>
  </main>
  <Footer 
    studioName={settings.studioName}
    headline={settings.footerHeadline}
    description={settings.footerDescription}
    mapImage={footerMapImage}
    emailLabel={settings.footerEmailLabel}
    emailDescription={settings.footerEmailDescription}
    phoneLabel={settings.footerPhoneLabel}
    phoneDescription={settings.footerPhoneDescription}
    studioLabel={settings.footerStudioLabel}
    email={settings.footerEmail}
    phone={settings.footerPhone}
    whatsAppUrl={settings.footerWhatsAppUrl}
    address={settings.footerAddress}
    privacyNote={settings.footerPrivacyNote}
    copyright={settings.footerCopyright}
    buttonGoogleMaps={settings.buttonGoogleMaps}
  />
</Layout>

<style>
  main {
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    overflow-y: visible;
    padding-top: 72px; /* Account for fixed header height */
  }

  /* Form Section */
  .form-section {
    width: 100%;
    max-width: 100%;
    background-color: var(--color-neutral-0);
    padding: var(--spacing-core-1100-md) 0;
    box-sizing: border-box;
    overflow-x: hidden;
  }

  .form-container,
  :global(.form-container) {
    max-width: 1440px;
    width: 100%;
    margin: 0 auto;
    padding: 0 var(--spacing-core-800-md);
    box-sizing: border-box;
  }

  .booking-form {
    width: 100%;
    max-width: 100%;
    display: flex;
    flex-direction: column;
    gap: 0;
    box-sizing: border-box;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--spacing-core-900-md);
    width: 100%;
    box-sizing: border-box;
  }

  .form-field {
    display: flex;
    flex-direction: column;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
  }

  .form-field-full {
    grid-column: 1 / -1;
  }

  /* Checkbox Group */
  .checkbox-group {
    display: flex;
    gap: var(--spacing-core-700-md);
    align-items: center;
    padding: var(--spacing-core-600-md) var(--spacing-core-700-md);
    background-color: var(--color-neutral-0);
    border: 1px solid var(--color-primary-600);
  }

  .checkbox-label-group {
    display: flex;
    gap: var(--spacing-core-300-md);
    align-items: center;
    flex: 1;
    font: var(--typography-body-lg);
  }

  .mandatory-indicator {
    color: var(--color-accent-600);
  }

  .checkbox-label {
    color: var(--color-primary-900);
  }

  /* Form Actions */
  .form-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-core-800-md);
    align-items: flex-end;
    justify-content: flex-start;
    padding-top: var(--spacing-core-900-md);
    width: 100%;
  }

  /* Mobile Responsive */
  @media (max-width: 767px) {
    main {
      padding-top: 64px;
    }

    .form-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-core-800-md);
    }

    .form-field-full {
      grid-column: 1;
    }

    .form-section {
      padding: var(--spacing-core-900-md) 0;
    }

    .form-container,
    :global(.form-container) {
      padding: 0 var(--spacing-core-600-md);
    }
  }

  /* Success/Error State - uses :global() for dynamically injected HTML */
  :global(.state-message) {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-core-800-md);
    min-height: 416px;
    padding: var(--spacing-core-800-md);
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto;
  }

  :global(.state-message--success) {
    background-color: var(--color-neutral-50);
    border: 1px solid var(--color-neutral-200);
  }

  :global(.state-message--error) {
    background-color: var(--color-accent-50);
    border: 1px solid var(--color-accent-200);
  }

  :global(.state-message__title) {
    font: var(--typography-heading-md);
    text-align: center;
    width: 100%;
    margin: 0;
  }

  :global(.state-message--success .state-message__title) {
    color: var(--color-neutral-900);
  }

  :global(.state-message--error .state-message__title) {
    color: var(--color-accent-900);
  }

  :global(.state-message__text) {
    font: var(--typography-body-md);
    text-align: center;
    width: 100%;
    margin: 0;
  }

  :global(.state-message--success .state-message__text) {
    color: var(--color-neutral-900);
  }

  :global(.state-message--error .state-message__text) {
    color: var(--color-accent-900);
  }

  :global(.state-message__actions) {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-core-800-md);
    align-items: center;
    justify-content: center;
    padding-top: var(--spacing-core-900-md);
    width: 100%;
  }

  /* Mobile responsive for state messages */
  @media (max-width: 767px) {
    :global(.state-message) {
      min-height: 300px;
      padding: var(--spacing-core-600-md);
    }
  }

  /* State buttons (secondary style) - uses :global() for dynamically injected HTML */
  :global(.state-button) {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-core-600-md);
    height: 48px;
    padding: var(--spacing-core-600-md) 0;
    background: none;
    border: none;
    cursor: pointer;
    text-decoration: none;
    font-family: 'Stack Sans Text', sans-serif;
    font-weight: 500;
    font-size: var(--font-size-core-700-md);
    line-height: var(--line-height-core-800-md);
    letter-spacing: var(--letter-spacing-core-100-md);
    text-transform: uppercase;
  }

  :global(.state-button--secondary) {
    color: var(--color-primary-600);
  }

  :global(.state-button--accent) {
    color: var(--color-accent-600);
  }

  :global(.state-button__text) {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  :global(.state-button__icon) {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
  }

  :global(.state-button:hover) {
    opacity: 0.8;
  }

  /* Error state for form fields */
  .field-error {
    border-color: var(--color-accent-600) !important;
  }

  .error-message {
    color: var(--color-accent-600);
    font: var(--typography-body-sm);
    margin-top: var(--spacing-core-300-md);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('booking-form') as HTMLFormElement;
    if (!form) return;

    const submitButton = form.querySelector('.form-actions button') as HTMLButtonElement;
    if (!submitButton) return;

    // Store original button content
    const originalButtonHTML = submitButton.innerHTML;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear previous errors
      form.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
      form.querySelectorAll('.error-message').forEach(el => el.remove());

      // Get form data
      const formData = new FormData(form);
      
      // Get checkbox state from custom Checkbox component (uses aria-checked attribute)
      const ageCheckbox = form.querySelector('.checkbox-group .checkbox[role="checkbox"]') as HTMLElement;
      const isAgeConfirmed = ageCheckbox?.getAttribute('aria-checked') === 'true';

      const data = {
        name: formData.get('name')?.toString().trim() || '',
        email: formData.get('email')?.toString().trim() || '',
        city: formData.get('city')?.toString().trim() || '',
        phone: formData.get('phone')?.toString().trim() || '',
        style: formData.get('style')?.toString() || '',
        artist: formData.get('artist')?.toString() || '',
        placement: formData.get('placement')?.toString().trim() || '',
        size: formData.get('size')?.toString().trim() || '',
        description: formData.get('description')?.toString().trim() || '',
        ageConfirmation: isAgeConfirmed,
      };

      // Validation
      let hasErrors = false;

      if (!data.name) {
        showFieldError('name', 'Name is required');
        hasErrors = true;
      }

      if (!data.email) {
        showFieldError('email', 'Email is required');
        hasErrors = true;
      } else {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(data.email)) {
          showFieldError('email', 'Please enter a valid email address');
          hasErrors = true;
        }
      }

      if (!data.style) {
        showFieldError('style', 'Please select a style');
        hasErrors = true;
      }

      if (!data.placement) {
        showFieldError('placement', 'Body placement is required');
        hasErrors = true;
      }

      if (!data.size) {
        showFieldError('size', 'Size is required');
        hasErrors = true;
      }

      if (!data.ageConfirmation) {
        const checkboxGroup = form.querySelector('.checkbox-group');
        if (checkboxGroup) {
          checkboxGroup.classList.add('field-error');
          const errorEl = document.createElement('span');
          errorEl.className = 'error-message';
          errorEl.textContent = 'You must confirm you are at least 18 years old';
          checkboxGroup.parentElement?.appendChild(errorEl);
        }
        hasErrors = true;
      }

      if (hasErrors) {
        // Scroll to first error
        const firstError = form.querySelector('.field-error');
        firstError?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      // Disable button and show loading state
      submitButton.setAttribute('disabled', 'true');
      submitButton.style.opacity = '0.7';
      submitButton.innerHTML = 'Submitting...';

      try {
        const response = await fetch('/api/booking', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Success - show success state matching Figma design
          showSuccessState();
        } else {
          throw new Error(result.error || 'Failed to submit booking');
        }
      } catch (error) {
        console.error('Submission error:', error);
        // Error - show error state matching Figma design
        showErrorState();
      }
    });

    function showFieldError(fieldName: string, message: string) {
      const field = form.querySelector(`[name="${fieldName}"]`);
      if (field) {
        const wrapper = field.closest('.form-field');
        const input = wrapper?.querySelector('input, select, textarea');
        input?.classList.add('field-error');
        
        const errorEl = document.createElement('span');
        errorEl.className = 'error-message';
        errorEl.textContent = message;
        wrapper?.appendChild(errorEl);
      }
    }

    function showSuccessState() {
      const formSection = form.closest('.form-section');
      if (formSection) {
        formSection.innerHTML = `
          <div class="form-container">
            <div class="state-message state-message--success">
              <p class="state-message__title">Request received</p>
              <p class="state-message__text">All set! Thanks for your request. Our artist will get back to you soon.</p>
              <div class="state-message__actions">
                <a href="/" class="state-button state-button--secondary">
                  <span class="state-button__text">Back to homepage</span>
                  <svg class="state-button__icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </a>
              </div>
            </div>
          </div>
        `;
        formSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function showErrorState() {
      const formSection = form.closest('.form-section');
      if (formSection) {
        // Store form HTML to restore later
        const formHTML = formSection.innerHTML;
        
        formSection.innerHTML = `
          <div class="form-container">
            <div class="state-message state-message--error">
              <p class="state-message__title">Something went wrong</p>
              <p class="state-message__text">Please try again and the artist will be able to get back to you.</p>
              <div class="state-message__actions">
                <button type="button" class="state-button state-button--secondary state-button--accent" id="try-again-btn">
                  <span class="state-button__text">Try again</span>
                  <svg class="state-button__icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14L18.36 18.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `;
        
        // Add click handler for try again button
        const tryAgainBtn = document.getElementById('try-again-btn');
        tryAgainBtn?.addEventListener('click', () => {
          // Reload the page to reset the form
          window.location.reload();
        });
        
        formSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  });
</script>
