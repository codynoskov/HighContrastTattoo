---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Divider from '../../components/Divider.astro';
import ArtistPageHeroSection from '../../components/sections/ArtistPageHeroSection.astro';
import ArtistContentSection from '../../components/sections/ArtistContentSection.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { getSlug, getWorksByArtist, worksToGalleryImages, resolveImagePath, resolveImage, resolveStyles } from '../../utils/contentHelpers';

export async function getStaticPaths() {
  const artists = await getCollection('artists');
  const works = await getCollection('works');
  const styles = await getCollection('styles');

  return artists.map((artist) => ({
    params: { slug: getSlug(artist) },
    props: { artist, works, styles, artists },
  }));
}

interface Props {
  artist: CollectionEntry<'artists'>;
  works: CollectionEntry<'works'>[];
  styles: CollectionEntry<'styles'>[];
  artists: CollectionEntry<'artists'>[];
}

const { artist, works, styles, artists } = Astro.props;

// Get settings content
const settingsEntries = await getCollection('settings');
const settings = settingsEntries[0]?.data || {};
const footerMapImage = settings.footerMapImage ? resolveImage(settings.footerMapImage) : undefined;
const artistData = artist.data;

// Render the markdown body content
const { Content } = await artist.render();

// Compute derived data
const artistSlug = getSlug(artist);
const artistWorks = getWorksByArtist(artistSlug, works);
const galleryImages = worksToGalleryImages(artistWorks, {
  context: 'artist',
  styles,
  artists,
});

// Resolve artist's manually selected styles to style links
const artistStyles = resolveStyles(artistData.styles ?? [], styles);

// Check if the artist has body content (markdown after frontmatter)
const hasBodyContent = artist.body && artist.body.trim().length > 0;

// SEO - Individual artist page
const siteUrl = settings.seoSiteUrl || 'https://highcontrasttattoo.com';
const siteName = settings.seoSiteName || 'High Contrast Tattoo';
const seoTitle = artistData.metaTitle || `${artistData.name} | ${siteName}`;
const seoDescription = artistData.metaDescription || artistData.intro.slice(0, 155) + (artistData.intro.length > 155 ? '...' : '');
const seoOgImage = artistData.ogImage || resolveImagePath(artistData.photo);
const artistPageUrl = `${siteUrl}/artists/${artistSlug}`;
const personImageUrl = typeof seoOgImage === 'string' && seoOgImage.startsWith('http')
  ? seoOgImage
  : `${siteUrl}${seoOgImage.startsWith('/') ? '' : '/'}${seoOgImage}`;
---

<Layout
  title={seoTitle}
  description={seoDescription}
  ogImage={seoOgImage}
  ogType="profile"
  canonicalUrl={artistPageUrl}
  noIndex={artistData.noIndex}
  includePersonSchema={true}
  personName={artistData.name}
  personImage={personImageUrl}
  personUrl={artistPageUrl}
  personSameAs={artistData.instagram ? `https://instagram.com/${artistData.instagram.replace('@', '')}` : undefined}
  breadcrumbItems={[
    { name: 'Home', url: siteUrl + '/' },
    { name: 'Artists', url: siteUrl + '/artists' },
    { name: artistData.name, url: artistPageUrl },
  ]}
>
  <Header 
    studioName={settings.studioName}
    buttonBookSession={settings.buttonBookSession}
  />
  <main>
    <ArtistPageHeroSection
      name={artistData.name}
      artistSlug={artistSlug}
      intro={artistData.intro}
      instagram={artistData.instagram}
      photo={resolveImage(artistData.photo)}
      styles={artistStyles}
    />
    
    <ArtistContentSection
      galleryImages={galleryImages}
      showBackLink={true}
      hasBodyContent={hasBodyContent}
    >
      {hasBodyContent && <Content />}
    </ArtistContentSection>
  </main>
  <Footer 
    studioName={settings.studioName}
    headline={settings.footerHeadline}
    description={settings.footerDescription}
    mapImage={footerMapImage}
    emailLabel={settings.footerEmailLabel}
    emailDescription={settings.footerEmailDescription}
    phoneLabel={settings.footerPhoneLabel}
    phoneDescription={settings.footerPhoneDescription}
    studioLabel={settings.footerStudioLabel}
    email={settings.footerEmail}
    phone={settings.footerPhone}
    whatsAppUrl={settings.footerWhatsAppUrl}
    address={settings.footerAddress}
    privacyNote={settings.footerPrivacyNote}
    copyright={settings.footerCopyright}
    buttonGoogleMaps={settings.buttonGoogleMaps}
  />
</Layout>

<style>
  main {
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: visible;
    overflow-y: visible;
    padding-top: 72px; /* Account for fixed header height */
  }
</style>
