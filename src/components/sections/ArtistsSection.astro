---
import Card from '../Card.astro';
import Button from '../Button.astro';
import placeholderImage from '../../assets/images/artist-placeholder.png';
import { getCollection } from 'astro:content';
import { getSlug, resolveImage, resolveStyles, getArtistSlugFromWork } from '../../utils/contentHelpers';
import type { ImageMetadata } from 'astro';

interface Props {
  title?: string;
  description?: string;
  ctaText?: string;
  ctaHref?: string;
  className?: string;
}

// Fetch content collections
const artistEntries = await getCollection('artists');
const worksEntries = await getCollection('works');
const styleEntries = await getCollection('styles');

// Sort artists by order if defined, otherwise alphabetically
const sortedArtists = [...artistEntries].sort((a, b) => {
  // If both have order, sort by order
  if (a.data.order !== undefined && b.data.order !== undefined) {
    return a.data.order - b.data.order;
  }
  
  // If only one has order, it comes first
  if (a.data.order !== undefined) return -1;
  if (b.data.order !== undefined) return 1;
  
  // If neither has order, sort alphabetically by name
  return a.data.name.localeCompare(b.data.name);
});

// Transform artists into card format
const artistsData = sortedArtists.map((entry) => {
  const slug = getSlug(entry);
  
  // Get works by this artist to determine their styles
  const artistWorks = worksEntries.filter(work => getArtistSlugFromWork(work) === slug);
  
  // Collect all unique styles from artist's works
  const allStyleSlugs = [...new Set(artistWorks.flatMap(work => work.data.styles))];
  const resolvedStyles = resolveStyles(allStyleSlugs, styleEntries);
  
  // Transform to tag format with links
  const artistTags = resolvedStyles.map(style => ({
    text: style.name,
    href: style.href
  }));
  
  // Resolve the artist photo - returns ImageMetadata if available, string otherwise
  const resolvedPhoto = entry.data.photo ? resolveImage(entry.data.photo) : placeholderImage;
  
  return {
    title: entry.data.name,
    description: entry.data.intro,
    image: resolvedPhoto,
    artistTags,
    instagram: entry.data.instagram,
    href: `/artists/${slug}`
  };
});

const {
  title = "Meet the Artists",
  description = "Our team brings years of experience across many tattoo styles. Explore portfolios and find the right artist for your idea.",
  ctaText = "Meet all our Artists",
  ctaHref = "/artists",
  className = ""
} = Astro.props;
---

<section class={`section section--carousel ${className}`}>
  <div class="container">
    <div class="section-text-block">
      <h2 class="section-title">{title}</h2>
      <p class="section-description">{description}</p>
      <div class="section-action" style="margin-top: var(--spacing-core-600-md);">
        <Button 
          type="Secondary" 
          color="Primary"
          href={ctaHref}
          leadingIcon={false}
          trailingIcon={true}
          trailingIconName="chevron-right"
        >
          {ctaText}
        </Button>
      </div>
    </div>
  </div>
  
  <div class="carousel-wrapper" style="margin-top: var(--spacing-core-900-md);">
    <div class="carousel">
      <div class="carousel-track">
        {artistsData.map((artist) => (
          <Card 
            type="Artist"
            fillHeight={false}
            title={artist.title}
            description={artist.description}
            descriptionSize="md"
            image={artist.image}
            artistTags={artist.artistTags}
            instagram={artist.instagram}
            href={artist.href}
          />
        ))}
      </div>
    </div>
  </div>
</section>

<style>
  /* All styles now handled by .section--carousel in tokens.css */
</style>
