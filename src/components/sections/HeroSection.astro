---
import Button from '../Button.astro';
import Logo from '../Logo.astro';
import OptimizedImage from '../OptimizedImage.astro';
import imagePlaceholder from '../../assets/images/image-placeholder.png';
import type { ImageMetadata } from 'astro';

interface Props {
  headline?: string;
  introText?: string;
  ctaText?: string;
  ctaHref?: string;
  videoSrc?: string;
  /** Video poster/thumbnail image shown while video loads */
  videoPoster?: string;
  /** Cloudflare Stream video UID (if using Stream instead of local video) */
  streamVideoId?: string;
  /** Cloudflare Stream customer code (found in Stream dashboard) */
  streamCustomerCode?: string;
  topRightImage?: string | ImageMetadata;
  bottomLeftImage?: string | ImageMetadata;
  className?: string;
}

const {
  headline = "Tattoos we design and shape together",
  introText = "**High Contrast Tattoo** is a Berlin-Friedrichshain studio known for combining classic tattoo motifs with contemporary stylistic elements and delivering detailed, high-quality custom work.",
  ctaText = "Book a session",
  ctaHref = "/book",
  videoSrc,
  videoPoster,
  streamVideoId,
  streamCustomerCode,
  topRightImage = imagePlaceholder,
  bottomLeftImage = imagePlaceholder,
  className = ""
} = Astro.props;

// Build Cloudflare Stream URL if stream props are provided
const streamUrl = streamVideoId && streamCustomerCode 
  ? `https://customer-${streamCustomerCode}.cloudflarestream.com/${streamVideoId}/iframe?autoplay=true&muted=true&loop=true&controls=false&preload=auto`
  : null;

// Parse intro text to handle **bold** markdown
function parseIntroText(text: string) {
  const parts = text.split(/(\*\*[^*]+\*\*)/g);
  return parts.map((part, index) => {
    if (part.startsWith('**') && part.endsWith('**')) {
      return { type: 'bold', text: part.slice(2, -2), key: index };
    }
    return { type: 'text', text: part, key: index };
  });
}

const introParts = parseIntroText(introText);
---

<section class={`hero-section ${className}`}>
  <div class="hero-container">
    <!-- Decorative Logo -->
    <div class="hero-logo-decoration" aria-hidden="true">
      <Logo width={192} height={418} class="hero-logo" />
    </div>

    <!-- Main Hero Content -->
    <div class="hero-layout">
      <!-- Text Content Area -->
      <div class="hero-content">
        <div class="hero-text-wrapper">
          <h1 class="hero-headline">{headline}</h1>
          <div class="hero-body">
            <p class="hero-intro">
              {introParts.map((part) => (
                part.type === 'bold' 
                  ? <strong>{part.text}</strong>
                  : <Fragment>{part.text}</Fragment>
              ))}
            </p>
            <div class="hero-cta">
<Button 
              type="Primary" 
              color="Accent" 
              href={ctaHref}
              leadingIcon={false}
              trailingIcon={true}
            >
              {ctaText}
            </Button>
            </div>
          </div>
        </div>
      </div>

      <!-- Media Area: Video + Images -->
      <div class="hero-media">
        <!-- Video Container -->
        <div class="hero-video-wrapper">
          {streamUrl ? (
            <div class="hero-video-stream-container">
              {/* Poster image as fallback for devices that don't support Stream */}
              {videoPoster && (
                <img 
                  src={videoPoster} 
                  alt="" 
                  class="hero-video-poster"
                  loading="eager"
                />
              )}
              <iframe 
                src={streamUrl}
                class="hero-video hero-video-stream"
                allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;"
                loading="eager"
              ></iframe>
            </div>
          ) : videoSrc ? (
            <video 
              autoplay 
              muted 
              loop 
              playsinline 
              preload="metadata"
              class="hero-video"
              poster={videoPoster}
            >
              <source src={videoSrc} type="video/mp4" />
            </video>
          ) : (
            <div class="hero-video-placeholder"></div>
          )}
        </div>

        <!-- Overlay Images -->
        <div class="hero-images-overlay">
          {topRightImage && (
            <div class="hero-image hero-image-top-right">
              <OptimizedImage
                src={topRightImage}
                alt="Tattoo artwork"
                loading="eager"
                widths={[300, 600, 900]}
                sizes="(max-width: 1023px) 33vw, 25vw"
                quality={85}
              />
            </div>
          )}
          {bottomLeftImage && (
            <div class="hero-image hero-image-bottom-left">
              <OptimizedImage
                src={bottomLeftImage}
                alt="Studio interior"
                loading="eager"
                widths={[300, 600, 900]}
                sizes="(max-width: 1023px) 33vw, 25vw"
                quality={85}
              />
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* ============================================
     HERO SECTION - BASE STYLES
     ============================================ */
  .hero-section {
    width: 100%;
    background-color: var(--color-primary-50);
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow: hidden;
    position: relative;
    padding: 0 0 var(--spacing-core-1000-sm) 0;
  }

  .hero-container {
    position: relative;
    width: 100%;
    max-width: var(--spacing-core-1900-md); /* 1440px */
    padding: 0 var(--spacing-core-800-md);
    isolation: isolate;
    margin: 0 auto;
  }

  /* ============================================
     DECORATIVE LOGO
     ============================================ */
  .hero-logo-decoration {
    position: absolute;
    left: 0; /* Align to left edge of container */
    top: 0; /* Align with section top */
    width: 192px;
    height: 418px;
    z-index: 1;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary-200);
    transform: scaleY(-1);
  }

  .hero-logo-decoration :global(.hero-logo) {
    display: block;
    width: 100%;
    height: 100%;
  }

  .hero-logo-decoration :global(.hero-logo svg) {
    width: 100%;
    height: 100%;
    display: block;
    fill: currentColor;
  }

  /* ============================================
     DESKTOP LAYOUT (768px+)
     ============================================ */
  .hero-layout {
    position: relative;
    height: var(--spacing-core-1700-lg); /* 720px */
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: 1fr;
  }

  /* Text Content - Left Side */
  .hero-content {
    grid-column: 1 / span 3;
    grid-row: 1;
    position: relative;
    z-index: 3;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap: var(--spacing-core-800-md);
    padding: var(--spacing-core-800-md);
  }

  .hero-text-wrapper {
    grid-column: 1 / span 6;
    grid-row: 1 / span 6;
    display: flex;
    flex-direction: column;
  }

  .hero-headline {
    flex: 0 0 auto;
    display: flex;
    align-items: flex-end;
    height: 50%;
    font: var(--typography-h1);
    color: var(--color-primary-900);
    margin: 0;
    max-width: var(--spacing-core-1800-md); /* 960px */
    padding-bottom: var(--spacing-core-800-md);
  }

  .hero-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    gap: var(--spacing-core-900-md);
    /* Constrain body to stay within columns 1-2 of the 5-column main grid */
    /* Content spans columns 1-3 (60%), body should use only 2/3 of that (40% = columns 1-2) */
    /* This prevents overlap with media section which starts at column 3 */
    max-width: calc(66.67% - var(--spacing-core-800-md));
  }

  .hero-intro {
    font: var(--typography-body-lg);
    color: var(--color-primary-900);
    margin: 0;
    /* Ensure intro text stays within the constrained body width */
    max-width: 100%;
  }

  .hero-intro strong {
    font-weight: var(--font-weight-bold);
  }

  .hero-cta {
    margin-top: var(--spacing-core-600-md);
  }

  /* Media Area - Right Side */
  .hero-media {
    grid-column: 3 / span 3;
    grid-row: 1;
    position: relative;
    z-index: 2;
    isolation: isolate;
  }

  /* Video Wrapper - Inner padding for video */
  .hero-video-wrapper {
    position: absolute;
    inset: 0;
    padding: var(--spacing-core-1100-md); /* 72px */
    z-index: 1;
  }

  .hero-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background-color: var(--color-neutral-300);
  }

  /* Show poster while video loads */
  .hero-video:not([poster]) {
    /* If no poster, show a subtle loading state */
    background: linear-gradient(
      135deg,
      var(--color-neutral-300) 0%,
      var(--color-neutral-400) 100%
    );
  }

  /* Loading state for slow connections */
  .hero-video.loading {
    opacity: 0.8;
  }

  .hero-video-stream-container {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .hero-video-poster {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
  }

  .hero-video-stream {
    position: relative;
    z-index: 1;
    border: none;
    pointer-events: none; /* Prevent interaction with video controls */
  }

  .hero-video-placeholder {
    width: 100%;
    height: 100%;
    background-color: var(--color-neutral-300);
  }

  /* Images Overlay - 6x6 grid positioning */
  .hero-images-overlay {
    position: absolute;
    inset: 0;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap: var(--spacing-core-800-md);
    padding: var(--spacing-core-800-md);
    z-index: 2;
    pointer-events: none;
  }

  .hero-image {
    position: relative;
    border: var(--spacing-core-300-md) solid var(--color-primary-50);
    overflow: hidden;
    pointer-events: auto;
  }

  .hero-image :global(img),
  .hero-image :global(picture) {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .hero-image :global(img) {
    width: 100%;
    height: 100%;
  }

  /* Top-right image: rows 1-2, cols 5-6 */
  .hero-image-top-right {
    grid-row: 1 / span 2;
    grid-column: 5 / span 2;
  }

  /* Bottom-left image: rows 5-6, cols 1-2 */
  .hero-image-bottom-left {
    grid-row: 5 / span 2;
    grid-column: 1 / span 2;
  }

  /* ============================================
     TABLET LAYOUT (768px - 1023px)
     ============================================ */
  @media (min-width: 768px) and (max-width: 1023px) {
    .hero-layout {
      height: auto;
      min-height: 600px;
    }

    .hero-logo-decoration {
      width: 140px;
      height: 320px;
      top: 0;
      left: 0;
    }

    .hero-video-wrapper {
      padding: var(--spacing-core-900-md);
    }

    .hero-content {
      padding: var(--spacing-core-700-md);
    }
  }

  /* ============================================
     MOBILE LAYOUT (< 768px)
     ============================================ */
  @media (max-width: 767px) {
    .hero-layout {
      height: auto;
      display: flex;
      flex-direction: column;
    }

    .hero-container {
      width: 100%;
      padding: 0;
      box-sizing: border-box;
      margin: 0;
    }

    .hero-logo-decoration {
      width: 120px;
      height: 260px;
      top: 0;
      left: 0;
    }

    /* Content comes first on mobile */
    .hero-content {
      order: 1;
      display: block;
      grid-column: unset;
      grid-row: unset;
      padding: var(--spacing-core-1100-md) var(--spacing-core-800-md) var(--spacing-core-800-md);
    }

    .hero-text-wrapper {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-core-800-md);
      grid-column: unset;
      grid-row: unset;
    }

    .hero-headline {
      height: auto;
      font: var(--typography-h1);
      padding-bottom: 0;
      display: block;
    }

    .hero-body {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-core-800-md);
      max-width: 100%;
    }

    .hero-intro {
      /* No special positioning - stays within content padding per Figma design */
    }

    .hero-cta {
      margin-top: var(--spacing-core-600-md);
    }

    /* Media comes after content */
    .hero-media {
      order: 2;
      position: relative;
      height: 416px;
      width: 100%;
      grid-column: unset;
      grid-row: unset;
    }

    .hero-video-wrapper {
      position: absolute;
      inset: 0;
      padding: var(--spacing-core-800-md);
    }

    .hero-images-overlay {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 0;
      padding: 0;
    }

    .hero-image-top-right {
      grid-row: 1 / span 2;
      grid-column: 5 / span 2;
    }

    .hero-image-bottom-left {
      grid-row: 5 / span 2;
      grid-column: 1 / span 2;
    }
  }

  /* ============================================
     LARGE SCREENS (1440px+)
     ============================================ */
  @media (min-width: 1440px) {
    .hero-container {
      margin: 0 auto;
    }
  }
</style>
