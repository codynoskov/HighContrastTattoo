---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Divider from '../../components/Divider.astro';
import StylePageHeroSection from '../../components/sections/StylePageHeroSection.astro';
import StyleContentSection from '../../components/sections/StyleContentSection.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { getSlug, getWorksByStyle, worksToGalleryImages, getArtistSlugFromWork } from '../../utils/contentHelpers';

export async function getStaticPaths() {
  const styles = await getCollection('styles');
  const works = await getCollection('works');
  const artists = await getCollection('artists');
  
  return styles.map((style) => ({
    params: { slug: getSlug(style) },
    props: { style, works, artists }
  }));
}

interface Props {
  style: CollectionEntry<'styles'>;
  works: CollectionEntry<'works'>[];
  artists: CollectionEntry<'artists'>[];
}

const { style, works, artists } = Astro.props;
const styleData = style.data;

// Render the markdown body content
const { Content } = await style.render();

// Get gallery images for this style
const styleSlug = getSlug(style);
const styleWorks = getWorksByStyle(styleSlug, works);
const galleryImages = worksToGalleryImages(styleWorks, {
  context: 'style',
  artists,
});

// Get unique artists who have works in this style
const styleArtistSlugs = new Set<string>();
styleWorks.forEach(work => {
  styleArtistSlugs.add(getArtistSlugFromWork(work));
});

// Map artist slugs to artist links
const styleArtists = artists
  .filter(artist => styleArtistSlugs.has(getSlug(artist)))
  .map(artist => ({
    name: artist.data.name,
    href: `/artists/${getSlug(artist)}`
  }));

// Check if the style has body content (markdown after frontmatter)
const hasBodyContent = style.body && style.body.trim().length > 0;
---

<Layout>
  <Header />
  <main>
    <StylePageHeroSection
      name={styleData.name}
      intro={styleData.intro}
      artists={styleArtists}
    />
    
    <StyleContentSection
      galleryImages={galleryImages}
      showBackLink={true}
      hasBodyContent={hasBodyContent}
    >
      {hasBodyContent && <Content />}
    </StyleContentSection>
    
    <Divider color="light" />
  </main>
  <Footer />
</Layout>

<style>
  main {
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: visible;
    overflow-y: visible;
    padding-top: 72px; /* Account for fixed header height */
  }
</style>
