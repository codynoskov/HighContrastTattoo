---
// OAuth callback handler for Decap CMS GitHub authentication
// Use Astro.request.url instead of Astro.url to get the actual request URL
const requestUrl = new URL(Astro.request.url);
const code = requestUrl.searchParams.get('code');
const state = requestUrl.searchParams.get('state');
const error = requestUrl.searchParams.get('error');

// Log all query parameters for debugging
const allParams = Object.fromEntries(requestUrl.searchParams.entries());
console.log('Callback received with params:', allParams);
console.log('Request URL:', Astro.request.url);
console.log('Astro.url:', Astro.url.toString());

const clientId = import.meta.env.GITHUB_CLIENT_ID;
const clientSecret = import.meta.env.GITHUB_CLIENT_SECRET;

// Try multiple methods to get the correct base URL
let baseUrl = import.meta.env.PUBLIC_BASE_URL;

if (!baseUrl) {
  // Try from request URL
  const requestUrl = new URL(Astro.request.url);
  baseUrl = `${requestUrl.protocol}//${requestUrl.host}`;
  
  // If still localhost, try headers
  if (baseUrl.includes('localhost')) {
    const host = Astro.request.headers.get('host');
    const protocol = Astro.request.headers.get('x-forwarded-proto') || 
                     Astro.request.headers.get('x-forwarded-scheme') || 
                     'https';
    if (host && !host.includes('localhost')) {
      baseUrl = `${protocol}://${host}`;
    }
  }
  
  // Final fallback - use production URL if we're not on localhost
  if (baseUrl.includes('localhost')) {
    baseUrl = 'https://hct-ana.pages.dev';
  }
}

const redirectUri = `${baseUrl}/api/callback`;

if (error) {
  const errorHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OAuth Error</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
    h1 { color: #d32f2f; }
  </style>
</head>
<body>
  <h1>OAuth Error</h1>
  <p>${error}</p>
  <p>Please try again.</p>
</body>
</html>
  `;
  return new Response(errorHtml, { 
    status: 400,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Content-Disposition': 'inline',
      'X-Content-Type-Options': 'nosniff',
    },
  });
}

if (!code) {
  // Show debug information about what was received
  const debugInfo = JSON.stringify(allParams, null, 2);
  const errorHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OAuth Error</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
    h1 { color: #d32f2f; }
    pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>OAuth Error</h1>
  <p>Missing authorization code</p>
  <p>Received parameters:</p>
  <pre>${debugInfo}</pre>
  <p>Request URL: ${Astro.request.url}</p>
  <p>Astro.url: ${Astro.url.toString()}</p>
  <p>Please try logging in again.</p>
</body>
</html>
  `;
  return new Response(errorHtml, { 
    status: 400,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Content-Disposition': 'inline',
      'X-Content-Type-Options': 'nosniff',
    },
  });
}

if (!clientId || !clientSecret) {
  const errorHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Configuration Error</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
    h1 { color: #d32f2f; }
  </style>
</head>
<body>
  <h1>Configuration Error</h1>
  <p>GitHub OAuth credentials are not configured</p>
  <p>Please configure GITHUB_CLIENT_ID and GITHUB_CLIENT_SECRET in your environment variables.</p>
</body>
</html>
  `;
  return new Response(errorHtml, { 
    status: 500,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Content-Disposition': 'inline',
      'X-Content-Type-Options': 'nosniff',
    },
  });
}

try {
  // Exchange authorization code for access token
  const tokenResponse = await fetch('https://github.com/login/oauth/access_token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    },
    body: JSON.stringify({
      client_id: clientId,
      client_secret: clientSecret,
      code: code,
      redirect_uri: redirectUri,
    }),
  });

  if (!tokenResponse.ok) {
    const errorText = await tokenResponse.text();
    const errorHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OAuth Error</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
    h1 { color: #d32f2f; }
  </style>
</head>
<body>
  <h1>OAuth Error</h1>
  <p>Failed to exchange code for token: ${errorText}</p>
  <p>Please try logging in again.</p>
</body>
</html>
    `;
    return new Response(errorHtml, { 
      status: 500,
      headers: {
        'Content-Type': 'text/html; charset=utf-8',
        'Content-Disposition': 'inline',
        'X-Content-Type-Options': 'nosniff',
      },
    });
  }

  const tokenData = await tokenResponse.json();
  
  if (tokenData.error) {
    const errorHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OAuth Error</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
    h1 { color: #d32f2f; }
  </style>
</head>
<body>
  <h1>OAuth Error</h1>
  <p>${tokenData.error_description || tokenData.error}</p>
  <p>Please try logging in again.</p>
</body>
</html>
    `;
    return new Response(errorHtml, { 
      status: 400,
      headers: {
        'Content-Type': 'text/html; charset=utf-8',
        'Content-Disposition': 'inline',
        'X-Content-Type-Options': 'nosniff',
      },
    });
  }

  const accessToken = tokenData.access_token;

  // Return HTML page that posts the token back to Decap CMS
  const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Authenticating...</title>
</head>
<body>
  <script>
    (function() {
      try {
        // Post the token back to Decap CMS
        // Decap CMS expects this specific message format
        const tokenData = {
          token: "${accessToken}",
          provider: "github"
        };
        const message = 'authorization:github:success:' + JSON.stringify(tokenData);
        
        if (window.opener && !window.opener.closed) {
          // Try posting to the exact origin first
          window.opener.postMessage(message, window.location.origin);
          
          // Also try posting to '*' as fallback (some Decap CMS versions need this)
          window.opener.postMessage(message, '*');
          
          // Give Decap CMS time to process the message
          setTimeout(function() {
            if (!window.opener.closed) {
              // Try to reload the opener to refresh the auth state
              try {
                window.opener.location.reload();
              } catch (e) {
                // Cross-origin, can't reload
              }
            }
            window.close();
          }, 500);
        } else {
          // If no opener, we might be in the same window - store token and redirect
          if (typeof localStorage !== 'undefined') {
            localStorage.setItem('netlify-cms-user', JSON.stringify(tokenData));
          }
          window.location.href = '/admin/';
        }
      } catch (e) {
        console.error('Error posting message:', e);
        // Fallback: redirect to admin page
        window.location.href = '/admin/';
      }
    })();
  </script>
  <p>Authentication successful. This window should close automatically.</p>
  <p>If it doesn't close, <a href="/admin/">click here</a> to go to the admin dashboard.</p>
</body>
</html>
  `;

  return new Response(html, {
    status: 200,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Content-Disposition': 'inline',
      'X-Content-Type-Options': 'nosniff',
    },
  });
} catch (error) {
  console.error('OAuth callback error:', error);
  const errorHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OAuth Error</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
    h1 { color: #d32f2f; }
  </style>
</head>
<body>
  <h1>OAuth Error</h1>
  <p>${error instanceof Error ? error.message : 'Unknown error'}</p>
  <p>Please try logging in again.</p>
</body>
</html>
  `;
  return new Response(errorHtml, { 
    status: 500,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Content-Disposition': 'inline',
      'X-Content-Type-Options': 'nosniff',
    },
  });
}
---

