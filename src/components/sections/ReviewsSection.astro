---
import ReviewCard from '../ReviewCard.astro';
import Button from '../Button.astro';
import Icon from '../Icon.astro';
import { getCollection } from 'astro:content';

interface Props {
  title?: string;
  subtitle?: string;
  googleMapsUrl?: string;
  buttonText?: string;
  className?: string;
}

// Fetch reviews from content collection
const reviewEntries = await getCollection('reviews');

// Sort reviews by order if defined
const sortedReviews = [...reviewEntries].sort((a, b) => {
  const orderA = a.data.order ?? 999;
  const orderB = b.data.order ?? 999;
  return orderA - orderB;
});

// Transform to ReviewCard format
const reviews = sortedReviews.map((entry) => ({
  rating: entry.data.rating ?? 5,
  text: entry.body,
  author: entry.data.author,
}));

const {
  title = "Experiences Shared",
  subtitle = "Trusted by hundreds with **100% positive** reviews",
  googleMapsUrl = "https://maps.google.com/?q=High+Contrast+Tattoo,+SchreinerstraÃŸe+6,+10247+Berlin,+Germany",
  buttonText = "Open in Google Maps",
  className = ""
} = Astro.props;

// Parse subtitle to handle **bold** markdown
function parseText(text: string) {
  const parts = text.split(/(\*\*[^*]+\*\*)/g);
  return parts.map((part, index) => {
    if (part.startsWith('**') && part.endsWith('**')) {
      return { type: 'bold', text: part.slice(2, -2), key: index };
    }
    return { type: 'text', text: part, key: index };
  });
}

const subtitleParts = parseText(subtitle);
---

<section class={`section section--basic section--reviews ${className}`}>
  <div class="container container--centered">
    <div class="reviews-header">
      <div class="google-logo">
        <svg width="74" height="24" viewBox="0 0 74 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9.24 8.19v2.46h5.88c-.18 1.38-.64 2.39-1.34 3.1-.86.86-2.2 1.8-4.54 1.8-3.62 0-6.45-2.92-6.45-6.54s2.83-6.54 6.45-6.54c1.95 0 3.38.77 4.43 1.76L15.4 2.5C13.94 1.08 11.98 0 9.24 0 4.28 0 .11 4.04.11 9s4.17 9 9.13 9c2.68 0 4.7-.88 6.28-2.52 1.62-1.62 2.13-3.91 2.13-5.75 0-.57-.04-1.1-.13-1.54H9.24z" fill="#4285F4"/>
          <path d="M25 6.19c-3.21 0-5.83 2.44-5.83 5.81 0 3.34 2.62 5.81 5.83 5.81s5.83-2.46 5.83-5.81c0-3.37-2.62-5.81-5.83-5.81zm0 9.33c-1.76 0-3.28-1.45-3.28-3.52 0-2.09 1.52-3.52 3.28-3.52s3.28 1.43 3.28 3.52c0 2.07-1.52 3.52-3.28 3.52z" fill="#EA4335"/>
          <path d="M53.58 7.49h-.09c-.57-.68-1.67-1.3-3.06-1.3-2.9 0-5.56 2.55-5.56 5.83 0 3.26 2.66 5.79 5.56 5.79 1.39 0 2.49-.62 3.06-1.32h.09v.81c0 2.22-1.19 3.41-3.1 3.41-1.56 0-2.53-1.12-2.93-2.07l-2.22.92c.64 1.54 2.33 3.43 5.15 3.43 2.99 0 5.52-1.76 5.52-6.05V6.49h-2.42v1zm-2.93 8.03c-1.76 0-3.1-1.5-3.1-3.52 0-2.05 1.34-3.54 3.1-3.54 1.74 0 3.1 1.5 3.1 3.54 0 2.02-1.36 3.52-3.1 3.52z" fill="#4285F4"/>
          <path d="M38 6.19c-3.21 0-5.83 2.44-5.83 5.81 0 3.34 2.62 5.81 5.83 5.81s5.83-2.46 5.83-5.81c0-3.37-2.62-5.81-5.83-5.81zm0 9.33c-1.76 0-3.28-1.45-3.28-3.52 0-2.09 1.52-3.52 3.28-3.52s3.28 1.43 3.28 3.52c0 2.07-1.52 3.52-3.28 3.52z" fill="#FBBC05"/>
          <path d="M58 .24h2.51v17.57H58z" fill="#34A853"/>
          <path d="M68.26 15.52c-1.3 0-2.22-.59-2.82-1.76l7.77-3.21-.26-.66c-.48-1.3-1.96-3.7-4.97-3.7-2.99 0-5.48 2.35-5.48 5.81 0 3.26 2.46 5.81 5.76 5.81 2.66 0 4.2-1.63 4.84-2.57l-1.98-1.32c-.66.96-1.56 1.6-2.86 1.6zm-.18-7.15c1.03 0 1.91.53 2.2 1.28l-5.25 2.17c0-2.44 1.73-3.45 3.05-3.45z" fill="#EA4335"/>
        </svg>
      </div>
      
      <div class="section-text-block">
        <h2 class="section-title">{title}</h2>
        <p class="section-description">
          {subtitleParts.map((part) => (
            part.type === 'bold' 
              ? <strong>{part.text}</strong>
              : <Fragment>{part.text}</Fragment>
          ))}
        </p>
      </div>
    </div>
    
    <div class="carousel" style="width: calc(100% + 48px); margin-left: -24px;">
      <div class="carousel-track">
        {reviews.map((review) => (
          <ReviewCard 
            rating={review.rating}
            text={review.text}
            author={review.author}
          />
        ))}
      </div>
    </div>
    
    <div class="section-action">
      <Button 
        type="Primary" 
        color="Primary"
        href={googleMapsUrl}
        leadingIcon={false}
        trailingIcon={true}
        trailingIconName="open"
        target="_blank"
        rel="noopener noreferrer"
      >
        {buttonText}
      </Button>
    </div>
  </div>
</section>

<style>
  /* Common section styles handled by .section--basic in tokens.css */
  
  .reviews-header {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-core-800-md);
    align-items: center;
    text-align: center;
    width: 100%;
  }

  .google-logo {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .section--reviews .section-text-block {
    text-align: center;
  }

  .section--reviews .section-description strong {
    font-weight: var(--font-weight-bold);
    color: var(--color-primary-900);
  }

  .section--reviews .section-action {
    justify-content: center;
  }

  .section--reviews .carousel-track {
    display: flex;
    padding: 0 24px;
  }

  @media (min-width: 768px) {
    .section--reviews .carousel-track {
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
      max-width: var(--spacing-container-large);
      padding: 0 24px;
    }
  }
</style>
