---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Divider from '../components/Divider.astro';
import HeroSection from '../components/sections/HeroSection.astro';
import ReviewsSection from '../components/sections/ReviewsSection.astro';
import InstagramPromoSection from '../components/sections/InstagramPromoSection.astro';
import StudioSection from '../components/sections/StudioSection.astro';
import WalkInTattoosSection from '../components/sections/WalkInTattoosSection.astro';
import StylesSection from '../components/sections/StylesSection.astro';
import ArtistsSection from '../components/sections/ArtistsSection.astro';
import ValuesSection from '../components/sections/ValuesSection.astro';
import { getCollection } from 'astro:content';
import { resolveImagePath } from '../utils/contentHelpers';

// Get homepage content
const homepageEntries = await getCollection('homepage');
const homepage = homepageEntries[0]?.data || {};

// Get settings content
const settingsEntries = await getCollection('settings');
const settings = settingsEntries[0]?.data || {};

// Helper function to safely resolve image paths (handles both strings and CMS objects)
function safeResolveImagePath(imagePath: any): string | undefined {
  if (!imagePath) return undefined;
  try {
    return resolveImagePath(imagePath);
  } catch (error) {
    console.warn('Failed to resolve image path:', imagePath, error);
    return undefined;
  }
}

// Resolve image and video paths (handles R2 URLs automatically and CMS objects)
const topRightImage = safeResolveImagePath(homepage.topRightImage);
const bottomLeftImage = safeResolveImagePath(homepage.bottomLeftImage);
const videoSrc = safeResolveImagePath(homepage.videoSrc);
const videoPoster = safeResolveImagePath(homepage.videoPoster);
const instagramBgImage = safeResolveImagePath(homepage.instagramBackgroundImage);
const walkInBgImage = safeResolveImagePath(homepage.walkInBackgroundImage);
const footerMapImage = safeResolveImagePath(settings.footerMapImage);

// Helper to safely get string values (filters out CMS metadata objects)
function safeString(value: any): string | undefined {
  if (!value) return undefined;
  if (typeof value === 'string') return value;
  // If it's an object, it might be CMS metadata - return undefined
  if (typeof value === 'object') {
    // Check for common image object patterns
    if (value.src) return String(value.src);
    if (value.url) return String(value.url);
    if (value.path) return String(value.path);
    // Otherwise it's metadata, skip it
    return undefined;
  }
  return String(value);
}

// SEO - Homepage uses custom values or falls back to global defaults
const seoTitle = safeString(homepage.metaTitle) || safeString(settings.seoSiteName) || 'High Contrast Tattoo Berlin';
const seoDescription = safeString(homepage.metaDescription) || safeString(settings.seoDefaultDescription);
const seoOgImage = safeResolveImagePath(homepage.ogImage) || safeResolveImagePath(settings.seoDefaultOgImage);
---

<Layout
	title={seoTitle}
	description={seoDescription}
	ogImage={seoOgImage}
	includeLocalBusiness={true}
>
	<Header 
		studioName={safeString(settings.studioName)}
		buttonBookSession={safeString(settings.buttonBookSession)}
	/>
	<main>
		<HeroSection 
			headline={safeString(homepage.headline)}
			introText={safeString(homepage.introText)}
			ctaText={safeString(settings.buttonBookSession)}
			ctaHref="/book"
			videoSrc={videoSrc}
			videoPoster={videoPoster}
			streamVideoId={safeString(homepage.streamVideoId)}
			streamCustomerCode={safeString(homepage.streamCustomerCode)}
			topRightImage={topRightImage}
			bottomLeftImage={bottomLeftImage}
		/>
		<ReviewsSection 
			title={safeString(homepage.reviewsTitle)}
			subtitle={safeString(homepage.reviewsSubtitle)}
			buttonText={safeString(settings.buttonGoogleMaps)}
		/>
		<InstagramPromoSection 
			title={safeString(homepage.instagramTitle)}
			instagramHandle={safeString(homepage.instagramHandle)}
			instagramUrl={safeString(homepage.instagramUrl)}
			backgroundImage={instagramBgImage}
			buttonText={safeString(settings.buttonInstagram)}
		/>
		<Divider />
		<StudioSection 
			title={safeString(homepage.studioTitle)}
			description={safeString(homepage.studioDescription)}
		/>
		<Divider />
		<WalkInTattoosSection 
			title={safeString(homepage.walkInTitle)}
			description={safeString(homepage.walkInDescription)}
			schedule={safeString(homepage.walkInSchedule)}
			backgroundImage={walkInBgImage}
			buttonText={safeString(settings.buttonGoogleMaps)}
		/>
		<Divider />
		<StylesSection 
			title={safeString(homepage.stylesTitle)}
			description={safeString(homepage.stylesDescription)}
			ctaText={safeString(homepage.stylesCtaText)}
		/>
		<Divider />
		<ValuesSection 
			title={safeString(homepage.valuesTitle)}
			description={safeString(homepage.valuesDescription)}
		/>
		<Divider />
		<ArtistsSection 
			title={safeString(homepage.artistsTitle)}
			description={safeString(homepage.artistsDescription)}
			ctaText={safeString(homepage.artistsCtaText)}
		/>
		<Divider />
	</main>
	<Footer 
		studioName={safeString(settings.studioName)}
		headline={safeString(settings.footerHeadline)}
		description={safeString(settings.footerDescription)}
		mapImage={footerMapImage}
		emailLabel={safeString(settings.footerEmailLabel)}
		emailDescription={safeString(settings.footerEmailDescription)}
		phoneLabel={safeString(settings.footerPhoneLabel)}
		phoneDescription={safeString(settings.footerPhoneDescription)}
		studioLabel={safeString(settings.footerStudioLabel)}
		email={safeString(settings.footerEmail)}
		phone={safeString(settings.footerPhone)}
		whatsAppUrl={safeString(settings.footerWhatsAppUrl)}
		address={safeString(settings.footerAddress)}
		privacyNote={safeString(settings.footerPrivacyNote)}
		copyright={safeString(settings.footerCopyright)}
		buttonGoogleMaps={safeString(settings.buttonGoogleMaps)}
	/>
</Layout>

<style>
	main {
		width: 100%;
		min-height: 100vh;
		display: flex;
		flex-direction: column;
		align-items: center;
		overflow-x: visible;
		overflow-y: visible;
		padding-top: 72px; /* Account for fixed header height */
	}
</style>
