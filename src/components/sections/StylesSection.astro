---
import Card from '../Card.astro';
import Button from '../Button.astro';
import placeholderImage from '../../assets/images/placeholder.png';
import { getCollection } from 'astro:content';
import { getSlug, getWorksByStyle, resolveImagePath, resolveArtistName, getArtistSlugFromWork } from '../../utils/contentHelpers';

interface Props {
  title?: string;
  description?: string;
  ctaText?: string;
  ctaHref?: string;
  className?: string;
}

// Fetch content collections
const styleEntries = await getCollection('styles');
const worksEntries = await getCollection('works');
const artistEntries = await getCollection('artists');

// Sort styles by order if defined
const sortedStyles = [...styleEntries].sort((a, b) => {
  const orderA = (a.data as any).order ?? 999;
  const orderB = (b.data as any).order ?? 999;
  return orderA - orderB;
});

// Transform styles into card format
const stylesData = sortedStyles.map((entry) => {
  const slug = getSlug(entry);
  const styleWorks = getWorksByStyle(slug, worksEntries);
  
  // Get the first work image for this style, or use placeholder
  const firstWork = styleWorks[0];
  const image = firstWork ? resolveImagePath(firstWork.data.image) : placeholderImage.src;
  
  // Get artist names who work in this style
  const artistNames = [...new Set(styleWorks.map(work => {
    return resolveArtistName(getArtistSlugFromWork(work), artistEntries);
  }).filter((name): name is string => name !== undefined))];
  
  return {
    title: entry.data.name,
    description: entry.data.intro,
    image,
    tags: artistNames,
    href: `/styles/${slug}`
  };
});

const {
  title = "Explore the Styles",
  description = "From neo-traditional and blackwork to lettering and geometric designs, our artists cover a wide range of styles.",
  ctaText = "Explore all Styles",
  ctaHref = "/styles",
  className = ""
} = Astro.props;
---

<section class={`section section--carousel ${className}`}>
  <div class="container">
    <div class="section-text-block">
      <h2 class="section-title">{title}</h2>
      <p class="section-description">{description}</p>
    </div>
  </div>
  
  <div class="carousel-wrapper" style="margin-top: var(--spacing-core-900-md);">
    <div class="carousel">
      <div class="carousel-track">
        {stylesData.map((style) => (
          <Card 
            type="Style"
            fillHeight={false}
            title={style.title}
            description={style.description}
            descriptionSize="lg"
            image={style.image}
            tags={style.tags}
            href={style.href}
          />
        ))}
      </div>
    </div>
  </div>
  
  <div class="container">
    <div class="section-action">
      <Button 
        type="Primary" 
        color="Primary"
        href={ctaHref}
        leadingIcon={false}
        trailingIcon={true}
      >
        {ctaText}
      </Button>
    </div>
  </div>
</section>

<style>
  /* All styles now handled by .section--carousel in tokens.css */
</style>
