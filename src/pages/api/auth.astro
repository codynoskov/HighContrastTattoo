---
// Server-side redirect to GitHub OAuth
// This endpoint handles the OAuth authentication flow
const clientId = import.meta.env.GITHUB_CLIENT_ID;
// Get the base URL from the request headers (more reliable in Cloudflare)
const host = Astro.request.headers.get('host') || Astro.url.host;
const protocol = Astro.request.headers.get('x-forwarded-proto') || 'https';
const baseUrl = `${protocol}://${host}`;

if (!clientId) {
  return new Response('GITHUB_CLIENT_ID is not configured', { 
    status: 500,
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}

const state = crypto.randomUUID();
const redirectUri = `${baseUrl}/api/callback`;
const authUrl = new URL('https://github.com/login/oauth/authorize');
authUrl.searchParams.set('client_id', clientId);
authUrl.searchParams.set('redirect_uri', redirectUri);
authUrl.searchParams.set('state', state);
authUrl.searchParams.set('scope', 'repo');

return Astro.redirect(authUrl.toString(), 302);
---

