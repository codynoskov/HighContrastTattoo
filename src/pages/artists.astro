---
// Artists listing page with gallery integration
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Divider from '../components/Divider.astro';
import ArtistsHeroSection from '../components/sections/ArtistsHeroSection.astro';
import ArtistDetailSection from '../components/sections/ArtistDetailSection.astro';
import { getCollection } from 'astro:content';
import { getSlug, getWorksByArtist, worksToGalleryImages, resolveStyles, resolveImagePath } from '../utils/contentHelpers';

// Get settings content
const settingsEntries = await getCollection('settings');
const settings = settingsEntries[0]?.data || {};
const footerMapImage = settings.footerMapImage ? resolveImagePath(settings.footerMapImage) : undefined;

// Get artists page content
const artistsPageEntries = await getCollection('artistsPage');
const artistsPage = artistsPageEntries[0]?.data || {};

// SEO - Artists page
const pageTitle = artistsPage.title || 'Artists';
const pageDescription = artistsPage.description || 'Our artists bring distinct styles and a shared focus on precision, creativity, and custom tattoo work.';
const seoTitle = artistsPage.metaTitle || `${pageTitle} | ${settings.seoSiteName || 'High Contrast Tattoo'}`;
const seoDescription = artistsPage.metaDescription || pageDescription;
const seoOgImage = artistsPage.ogImage || settings.seoDefaultOgImage;

const artistEntries = await getCollection('artists');
const worksEntries = await getCollection('works');
const stylesEntries = await getCollection('styles');

// Sort artists by order if defined, otherwise alphabetically
const sortedArtists = [...artistEntries].sort((a, b) => {
  // If both have order, sort by order
  if (a.data.order !== undefined && b.data.order !== undefined) {
    return a.data.order - b.data.order;
  }
  
  // If only one has order, it comes first
  if (a.data.order !== undefined) return -1;
  if (b.data.order !== undefined) return 1;
  
  // If neither has order, sort alphabetically by name
  return a.data.name.localeCompare(b.data.name);
});

const artists = sortedArtists.map(entry => {
  const artistSlug = getSlug(entry);
  const artistWorks = getWorksByArtist(artistSlug, worksEntries);
  const galleryImages = worksToGalleryImages(artistWorks, {
    context: 'artist',
    styles: stylesEntries,
  });
  
  // Resolve artist's manually selected styles to style links
  const styles = resolveStyles(entry.data.styles ?? [], stylesEntries);
  
  return {
    name: entry.data.name,
    slug: artistSlug,
    intro: entry.data.intro,
    instagram: entry.data.instagram,
    photo: resolveImagePath(entry.data.photo),
    styles,
    galleryImages,
  };
});
---

<Layout
  title={seoTitle}
  description={seoDescription}
  ogImage={seoOgImage}
>
  <Header 
    studioName={settings.studioName}
    buttonBookSession={settings.buttonBookSession}
  />
  <main>
    <ArtistsHeroSection 
      title={pageTitle}
      description={pageDescription}
    />
    
    <Divider color="light" />
    
    {artists.map((artist, index) => (
      <>
        <ArtistDetailSection
          name={artist.name}
          slug={artist.slug}
          intro={artist.intro}
          instagram={artist.instagram}
          photo={artist.photo}
          styles={artist.styles}
          galleryImages={artist.galleryImages}
        />
        {index < artists.length - 1 && <Divider color="light" />}
      </>
    ))}
    
    <Divider color="light" />
  </main>
  <Footer 
    studioName={settings.studioName}
    headline={settings.footerHeadline}
    description={settings.footerDescription}
    mapImage={footerMapImage}
    emailLabel={settings.footerEmailLabel}
    emailDescription={settings.footerEmailDescription}
    phoneLabel={settings.footerPhoneLabel}
    phoneDescription={settings.footerPhoneDescription}
    studioLabel={settings.footerStudioLabel}
    email={settings.footerEmail}
    phone={settings.footerPhone}
    whatsAppUrl={settings.footerWhatsAppUrl}
    address={settings.footerAddress}
    privacyNote={settings.footerPrivacyNote}
    copyright={settings.footerCopyright}
    buttonGoogleMaps={settings.buttonGoogleMaps}
  />
</Layout>

<style>
  main {
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: visible;
    overflow-y: visible;
    padding-top: 72px; /* Account for fixed header height */
  }
</style>
